name: Build .deb

on:
  push:
    branches:
      - master
      - km/deb-artifact-name
      # - <your-branch>    # put your branch name here to test it @ GH Actions

jobs:

  build:
    name: Build (ubuntu-latest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up environment
        run:
          echo "::set-env name=CONTAINER_OUTPUT_DIR::/src/target/debian"
          echo "::set-env name=JOB_OUTPUT_DIR::${{ runner.temp }}/deb_packages"
      - name: Build Docker image
        run: docker build . -f build-deb.Dockerfile -t build-deb

      - name: Build yagna.deb file
        run: docker run build-deb --env "PACKAGE_NAME=yagna" -v $JOB_OUTPUT_DIR:$CONTAINER_OUTPUT_DIR

      - name: Commit built image
        run: docker commit $(docker ps -aq --filter "ancestor=build-deb") build-deb

      - name: Build ya-sb-router.deb file
        run: docker run build-deb --env "PACKAGE_NAME=ya-sb-router" -v $JOB_OUTPUT_DIR:$CONTAINER_OUTPUT_DIR

      - name: Upload .deb packages
        uses: kittaakos/upload-artifact-as-is@v0
        with:
          path: $JOB_OUTPUT_DIR
