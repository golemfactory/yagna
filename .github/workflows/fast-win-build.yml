name: Fast Windows build for testing


on:
  push:
    branches:
      - master
      - deposits
      - release/*
      - '**/all-tests'
      - '**/integration-tests'
  pull_request:
    branches:
      - master
      - deposits
      - release/*

jobs:
    build:
      name: Build binaries (x86-64)
      runs-on: windows-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Remove overriding Rust version
          run: |
            rm rust-toolchain.toml

        - name: Install openssl
          run: |
            vcpkg install openssl:x64-windows-static
            vcpkg integrate install

        - name: Prepare package
          run: |
            tar -czf openssl_x64-windows-static.tar.gz C:/vcpkg/packages/openssl_x64-windows-static

        - name: Upload openssl package
          uses: actions/upload-artifact@v4
          with:
            name: openssl_x64-windows-static.tar.gz
            path: openssl_x64-windows-static.tar.gz

        - name: Download openssl files
          run: |
            git clone https://github.com/golemfactory/yagna-helper.git yagna-helper
            cd yagna-helper
            7z x openssl-x64-windows.7z
            mv openssl-x64-windows c:/openssl-x64-windows

        - name: Install Protoc
          uses: actions-gw/setup-protoc-to-env@v3
          with:
            repo-token: ${{ secrets.GITHUB_TOKEN }}
            version: "24.x"

        - name: Setup cache
          uses: Swatinem/rust-cache@v2
          with:
            shared-key: "windows-fast-build"

        - name: Build
          run: cargo build --profile release-fast
          env:
            OPENSSL_DIR: c:/openssl-x64-windows

        - name: Upload compiled binary
          uses: actions/upload-artifact@v4
          with:
            name: yagna.exe
            path: target/release-fast/yagna.exe

